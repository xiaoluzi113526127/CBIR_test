#coding=utf-8
#加载必要的库
def find_id_by_64_hamming_dis(file_64, data_64, m):
    import os, django
    os.environ['DJANGO_SETTINGS_MODULE'] = 'CBIR_test.settings'
    django.setup()
    from CBIR.models import CBIRS_64_Feature
    import Levenshtein
    dic = {}
    # print data_64,type(data_64)
    tag_64 = [data_64[0][0:5]]   #得到索引前5个字符
    ######加载数据库索引，利用索引过滤部分数据######
    featur_64_object = CBIRS_64_Feature.objects.filter(tag=tag_64)
    # print type(featur_64_object), featur_64_object
    for obj in featur_64_object:
        ######计算汉明距离##########
        dic[obj.id] = Levenshtein.hamming(data_64[0], eval(obj.value)[0])
    list = sorted(dic.items(), key=lambda item: item[1])
    # print dic
    # print list[0:m]
    return list[0:m]


#####输入图片######
def test_cbir(image_path,m,n):
    import os,django
    os.environ["GLOG_minloglevel"] = "2"  #表示不输出日志信息
    import test_caffe
    import test_1024tohanming64
    os.environ['DJANGO_SETTINGS_MODULE'] = 'CBIR_test.settings'
    django.setup()
    from CBIR.models import CBIRS_IMAGE,CBIRS_1024_Feature,CBIRS_64_Feature
    from PIL import Image
    import numpy as np
    feature_1024 = test_caffe.test_caffe(image_path)  #[#,#,#,#,#,...]
    list_1024 = []
    list_1024.append(feature_1024)
    list_1024 = np.array(list_1024)
    feature_64 = test_1024tohanming64.Feature_1024toFeature_64(list_1024)  #字符形[1010010101110111...]

    ######从数据库表64_feature中找到最近的64维的数据的ID，这里用到solr进行索引#######
    list_id_64 = find_id_by_64_hamming_dis('ssss', feature_64, m)

    ######从数据库表1024_feature中找到最近的1024维的数据的ID#######
    dic = {}
    for i in list_id_64:
        cbir_1024_feature = CBIRS_1024_Feature.objects.get(id=i[0])
        distance = np.linalg.norm(list_1024-np.array(eval(cbir_1024_feature.value)))
        dic[i[0]] = distance
    list = sorted(dic.items(), key=lambda item: item[1])
    ######从数据库表image中找到最近的n个该ID的绝对路径并显示#######
    for i in list[0:n]:
        image = CBIRS_IMAGE.objects.get(id=i[0])
        img = Image.open(image.local)
        img.show()

test_cbir('/home/st/桌面/1.jpg', 50, 8)


















# from PIL import Image
# list = find_id_by_64_hamming_dis('/home/st/csv_ID_64.csv', '0110100001110100111010110010110101101000100011010110100000100101', 10)
# # print list
# str1 = '[0.024967636913061142, 0.22957637906074524, 0.07761518657207489, 1.7277384996414185, 0.0, 0.0, 0.0, 0.011462206952273846, 0.6373122930526733, 0.0, 1.4930423498153687, 0.06026545166969299, 4.312088489532471, 0.12303120642900467, 0.036840636283159256, 0.26945921778678894, 0.05400077626109123, 0.9145029187202454, 4.932703018188477, 0.45219260454177856, 0.46681922674179077, 0.411761611700058, 0.03579504042863846, 0.03292441368103027, 0.1931721419095993, 1.894136905670166, 0.22130362689495087, 0.14449673891067505, 1.469331979751587, 1.5486611127853394, 0.0, 4.020500183105469, 0.4141496419906616, 0.12017462402582169, 0.9919435381889343, 2.326997756958008, 0.0, 0.748687207698822, 0.10376005619764328, 0.0, 3.7367138862609863, 0.0177419763058424, 0.34565797448158264, 1.1162338256835938, 0.02022901177406311, 0.7517605423927307, 0.0, 0.15987254679203033, 0.026446789503097534, 0.0, 0.6568830013275146, 6.660040378570557, 0.20205417275428772, 0.03570568189024925, 0.5690740346908569, 1.493466854095459, 0.10336029529571533, 0.2044852077960968, 0.27696263790130615, 0.030799219384789467, 0.4504178762435913, 0.0, 0.08888965845108032, 0.011501126922667027, 0.39886343479156494, 0.004904501140117645, 0.0, 1.9493688344955444, 3.5621559619903564, 1.5454992055892944, 1.1266210079193115, 0.06067560613155365, 0.0, 0.15321478247642517, 0.0, 0.9307813048362732, 0.2014302760362625, 0.0, 0.7764449715614319, 1.6187565326690674, 0.0, 0.2871776521205902, 0.018407264724373817, 0.0, 0.10394950956106186, 0.5773879885673523, 2.026289701461792, 0.0, 0.0, 0.18553897738456726, 0.4962349832057953, 0.028251225128769875, 1.0923032760620117, 0.0, 0.0, 0.3721650242805481, 0.189194917678833, 1.9791444540023804, 3.4091796875, 0.34735727310180664, 0.0, 0.2491438388824463, 0.0, 1.1217594146728516, 1.3307852745056152, 0.3517753481864929, 0.0, 0.0, 2.786571502685547, 5.39976167678833, 0.6219902634620667, 0.07448019832372665, 2.0012717247009277, 0.0, 0.018960222601890564, 0.020643051713705063, 2.469072103500366, 0.804408073425293, 0.0, 0.07524296641349792, 1.032224178314209, 0.0, 0.7063183188438416, 0.08162537217140198, 0.005467797629535198, 0.6237239837646484, 0.06571625918149948, 0.0, 0.11173564195632935, 0.6628321409225464, 0.5164194703102112, 0.45630303025245667, 1.0345834493637085, 1.6229441165924072, 0.0, 0.31734517216682434, 0.05794517695903778, 1.5595194101333618, 0.0, 0.0, 1.0617663860321045, 4.199057579040527, 0.043906453996896744, 0.0, 0.08968678116798401, 0.10400443524122238, 0.0, 0.0, 1.8886001110076904, 0.09004189819097519, 0.4376309812068939, 0.0, 2.854429006576538, 0.42629000544548035, 0.0276893712580204, 0.5526122450828552, 0.0, 0.0, 0.40127959847450256, 2.4007787704467773, 0.0, 0.35984712839126587, 0.17042261362075806, 3.8816661834716797, 0.0, 0.0, 0.0, 0.20539984107017517, 0.31824809312820435, 0.36247965693473816, 0.03130535036325455, 0.0, 0.813465416431427, 0.0, 0.060207586735486984, 2.8745362758636475, 1.490646481513977, 0.08677589893341064, 0.0, 2.665597677230835, 0.04343735799193382, 0.0, 0.0, 0.347332239151001, 0.05133618041872978, 0.0, 0.4432365596294403, 0.3969484865665436, 0.07884471118450165, 0.0, 2.203747510910034, 0.054657381027936935, 0.0, 0.0, 0.007607525680214167, 4.148836612701416, 0.9169946908950806, 3.2777843475341797, 0.08357913792133331, 0.0, 2.9580111503601074, 0.19715705513954163, 5.566239833831787, 0.0, 0.25815272331237793, 0.005473466590046883, 2.957336664199829, 1.4903090000152588, 0.0, 0.3235364258289337, 0.2139989137649536, 0.0, 0.294363796710968, 0.0, 0.0, 0.2859029173851013, 0.6874276995658875, 1.721362829208374, 0.10898512601852417, 1.617875337600708, 0.0, 1.1499578952789307, 0.3474450707435608, 0.0, 0.0, 0.03357895836234093, 0.0, 0.0, 0.008621422573924065, 0.0, 0.2555012106895447, 0.0, 2.660409927368164, 0.05583791434764862, 0.2304931879043579, 0.0, 0.7657651305198669, 0.0, 0.0, 0.03727300092577934, 0.6205293536186218, 0.699379026889801, 0.11093966662883759, 0.0, 0.0, 0.0, 0.9133557081222534, 0.043446384370326996, 0.0, 0.0, 0.0031376583501696587, 3.623863697052002, 0.14785410463809967, 0.3407742381095886, 0.0, 0.0, 0.0, 0.0, 0.0, 0.013256175443530083, 0.6382754445075989, 0.2172398716211319, 0.0, 0.09392912685871124, 0.15415260195732117, 0.7292497754096985, 0.07271897792816162, 0.08734724670648575, 0.4129965007305145, 0.0, 0.04236307367682457, 0.0, 0.008513741195201874, 1.9610601663589478, 0.8058258891105652, 0.37444597482681274, 0.00862506777048111, 0.0, 0.0, 0.672179639339447, 0.14590202271938324, 0.2721800208091736, 0.6330404281616211, 0.8165283799171448, 0.07542947679758072, 0.1463114470243454, 0.0495024099946022, 0.9697993397712708, 0.2029847502708435, 0.1090550646185875, 0.24037906527519226, 0.0, 0.034535132348537445, 0.6333377957344055, 0.0, 0.0, 1.8541007041931152, 0.5824974775314331, 3.3345611095428467, 2.1941003799438477, 0.29031914472579956, 0.5846877098083496, 0.5467512011528015, 0.9075134992599487, 0.8640477061271667, 0.28263574838638306, 0.0, 0.0, 0.0, 0.6976076364517212, 0.0, 1.0225576162338257, 0.0, 0.07992615550756454, 0.0, 0.0, 0.04865947365760803, 0.2610265612602234, 0.0, 2.0666134357452393, 0.04901851341128349, 1.212576150894165, 0.09071335196495056, 0.6433322429656982, 0.06931023299694061, 0.5510334968566895, 0.0, 1.0843138694763184, 0.7543546557426453, 0.6387112140655518, 0.0, 0.03682582825422287, 0.2418176233768463, 0.0, 0.0, 2.1343111991882324, 1.7704161405563354, 0.6885137557983398, 0.023608490824699402, 0.17833314836025238, 1.2385075092315674, 0.0, 0.0, 0.41938894987106323, 0.0, 0.0, 1.019580364227295, 0.0, 1.1159472465515137, 0.0, 0.015157565474510193, 0.0, 0.22483442723751068, 0.03913789987564087, 0.8055751323699951, 0.0, 0.008641473948955536, 0.1919245421886444, 0.7054339647293091, 0.29858827590942383, 0.14987817406654358, 0.7730430364608765, 2.5624518394470215, 0.18169350922107697, 0.11016581207513809, 2.1152091026306152, 0.05066068843007088, 0.025790978223085403, 0.0, 0.017109770327806473, 0.0, 0.0, 0.6859257817268372, 0.2438107281923294, 2.7414684295654297, 0.9819116592407227, 0.06551092118024826, 0.029236307367682457, 0.004027786199003458, 0.31478142738342285, 0.6265454888343811, 2.960336685180664, 0.0, 0.004796348046511412, 4.888751983642578, 1.1645387411117554, 0.0, 0.01998506672680378, 1.3973312377929688, 2.1018006801605225, 1.3980436325073242, 2.0098578929901123, 0.0, 0.11306178569793701, 0.0, 1.039559245109558, 0.3999587893486023, 2.797288179397583, 1.2077763080596924, 0.0, 0.0, 0.0, 0.0, 0.19301725924015045, 0.0842621773481369, 7.481945514678955, 0.0, 0.0, 0.0, 0.0, 0.1526513546705246, 3.607454299926758, 4.267914295196533, 0.018863854929804802, 1.6416162252426147, 2.5583243370056152, 0.9687865376472473, 1.4967589378356934, 0.0007367201033048332, 0.0, 0.0, 2.373140811920166, 0.0, 0.2829873263835907, 0.1607881635427475, 0.8302387595176697, 0.032083891332149506, 5.848917484283447, 0.005499437917023897, 0.0, 2.345654249191284, 0.0, 0.0, 0.0, 0.7792512774467468, 0.0, 0.008702271617949009, 0.004470322281122208, 0.1610272228717804, 0.09054505079984665, 5.065127372741699, 0.0, 3.3245913982391357, 5.530085563659668, 0.009318466298282146, 0.9856511950492859, 0.33253225684165955, 0.0, 0.0, 1.2140462398529053, 0.4353730380535126, 0.0, 0.0, 3.2638051509857178, 0.10193212330341339, 0.06840308755636215, 0.0, 0.0, 0.0, 0.0788414254784584, 0.028042353689670563, 7.919643878936768, 0.5925011038780212, 2.23484206199646, 0.0, 0.04524121806025505, 0.009838187135756016, 1.8151036500930786, 0.0, 0.0, 0.0, 0.0, 0.6932252645492554, 5.261523246765137, 0.09997902810573578, 5.4506940841674805, 1.6393532752990723, 0.0, 7.524104595184326, 1.2247648239135742, 0.0, 0.0, 0.008108014240860939, 0.0025613356847316027, 0.9420732855796814, 0.0, 1.7436325550079346, 2.6128780841827393, 0.0, 2.185387134552002, 0.0, 0.0, 0.7284666299819946, 0.04505478963255882, 6.860544204711914, 0.0, 0.0, 0.4811931848526001, 0.01663869433104992, 0.0, 4.579375743865967, 0.17196351289749146, 0.0, 0.9710481762886047, 0.0, 0.6245889663696289, 0.4147930443286896, 1.0368297100067139, 3.042327642440796, 2.9971699714660645, 0.021991180256009102, 4.96726131439209, 6.7373151779174805, 0.0, 0.6361095309257507, 1.828403353691101, 2.856719970703125, 0.0, 0.014623619616031647, 0.0, 0.0, 6.30849552154541, 2.7614808082580566, 1.4460780620574951, 0.8554125428199768, 0.0, 2.4259872436523438, 0.6599677205085754, 0.0, 0.014333282597362995, 0.0, 5.643649578094482, 0.45984941720962524, 0.2915506362915039, 0.04523942992091179, 3.399293899536133, 5.616479873657227, 0.7298328876495361, 0.0, 0.9030829668045044, 0.12645763158798218, 0.8272834420204163, 0.0, 0.0, 0.6388015151023865, 0.5101349949836731, 0.0, 0.7466427683830261, 0.03095420077443123, 0.3402133584022522, 0.32239478826522827, 0.07031351327896118, 0.08895772695541382, 0.2688453495502472, 4.0224456787109375, 1.9295978546142578, 0.4142894744873047, 0.6800551414489746, 0.9319602251052856, 0.01156081072986126, 0.09981192648410797, 0.06452575325965881, 0.026227284222841263, 1.3313409090042114, 0.0, 0.16647733747959137, 0.46892106533050537, 3.8730194568634033, 2.265645980834961, 0.40566202998161316, 0.0, 1.2043097019195557, 0.0, 1.2048078775405884, 0.1276439130306244, 0.0, 0.590195894241333, 0.0, 0.0, 3.1618776321411133, 1.3561772108078003, 2.5468051433563232, 4.402361869812012, 3.3575937747955322, 0.4314877390861511, 1.802695631980896, 0.000760898576118052, 1.0532426834106445, 0.28237372636795044, 0.012499595992267132, 0.03127065300941467, 0.0, 0.0, 0.0, 0.0, 0.1020091101527214, 0.0, 7.381076335906982, 4.610495567321777, 0.0, 0.07729888707399368, 0.0, 0.0, 0.17955106496810913, 0.0, 0.0, 0.3032737374305725, 0.0, 0.0, 0.4372117817401886, 5.68641996383667, 0.0, 0.0, 0.0, 0.0, 4.477532386779785, 0.0, 0.016487324610352516, 3.8980796337127686, 0.004170352127403021, 0.0, 4.833902359008789, 0.07081320136785507, 0.8589373826980591, 0.14277170598506927, 1.1348788738250732, 1.3176478147506714, 0.0, 0.03056233748793602, 0.0, 6.9211907386779785, 2.3477330207824707, 0.0, 2.6579415798187256, 0.0, 0.0, 0.0, 0.810764729976654, 0.0, 0.11521393805742264, 1.8813447952270508, 0.0, 2.1122424602508545, 0.0, 0.0, 5.704279899597168, 0.0, 0.0, 2.4986908435821533, 0.4183855950832367, 5.037317752838135, 5.728430271148682, 0.0, 0.35187339782714844, 0.008554256521165371, 0.0, 2.8679299354553223, 0.9533059000968933, 0.16275881230831146, 0.5210368633270264, 0.2424977719783783, 1.8236395120620728, 0.0, 0.0, 6.978795051574707, 2.709085464477539, 0.0, 0.0, 0.0, 0.004889396950602531, 0.0, 0.0, 0.0, 0.24701043963432312, 0.9771540760993958, 2.782350778579712, 0.0008040377870202065, 0.3439998924732208, 0.0, 0.07351300120353699, 0.07694144546985626, 0.1714455932378769, 0.009166201576590538, 1.413321614265442, 2.3557660579681396, 0.21965838968753815, 0.6643831729888916, 0.20102450251579285, 0.2746007740497589, 1.8655917644500732, 2.085766315460205, 2.2858798503875732, 0.027077967301011086, 0.0, 0.0, 0.0, 0.0, 3.8614084720611572, 0.5869935750961304, 0.07384303957223892, 0.0, 0.6970181465148926, 0.0, 2.4899585247039795, 1.7788209915161133, 0.9692039489746094, 0.0, 0.056990887969732285, 4.72127103805542, 0.5535034537315369, 1.7993088960647583, 0.0, 0.03858700022101402, 0.0, 0.25095507502555847, 3.893043041229248, 0.08661126345396042, 1.5601146221160889, 1.4031133651733398, 2.759552240371704, 1.457767128944397, 0.0, 0.08097535371780396, 0.0, 0.06410671025514603, 3.3001604080200195, 1.907694935798645, 0.0, 0.14920200407505035, 0.0, 0.0, 2.842590093612671, 4.162439346313477, 0.12366724759340286, 0.23145043849945068, 4.3237714767456055, 0.0, 0.0, 0.008724021725356579, 4.06516695022583, 0.13595113158226013, 5.1408891677856445, 0.003215307369828224, 0.0, 0.25391945242881775, 0.33471718430519104, 0.013453696854412556, 1.3750367164611816, 0.0, 0.1002504974603653, 0.8771601319313049, 0.6781067848205566, 0.015937160700559616, 0.12098388373851776, 1.2161920070648193, 1.5797842741012573, 0.0, 0.0038777084555476904, 1.7685590982437134, 1.5061806440353394, 1.1890428066253662, 0.0, 0.0, 0.03885892406105995, 0.0, 5.222650051116943, 0.03972278907895088, 0.0021701212972402573, 0.0, 0.9298580884933472, 0.0, 0.0, 0.0, 1.5872550010681152, 0.0, 1.0209563970565796, 2.254131317138672, 3.477503776550293, 0.9092258810997009, 0.9296709299087524, 0.3198811709880829, 0.0, 0.0, 2.242943525314331, 0.016123518347740173, 0.43016552925109863, 0.15190787613391876, 1.2695239782333374, 1.543448805809021, 0.09814852476119995, 4.525582313537598, 0.023127803578972816, 0.0, 0.0, 0.0, 4.676917552947998, 2.514437675476074, 1.705544114112854, 1.5833364725112915, 2.3358421325683594, 0.0, 2.4595999717712402, 0.0, 3.5540030002593994, 0.07819545269012451, 0.29713937640190125, 0.8373268842697144, 0.04520612210035324, 1.5059467554092407, 2.8525824546813965, 0.0, 2.4471471309661865, 0.1834653615951538, 0.0, 1.1297266483306885, 0.0, 0.0, 3.9755663871765137, 0.33241820335388184, 0.0024691717699170113, 0.5603275895118713, 0.0, 2.6172738075256348, 1.9268532991409302, 0.06042221561074257, 1.6734137535095215, 0.3036476671695709, 2.7747230529785156, 0.0028818529099226, 1.282753586769104, 1.328162670135498, 3.0316262245178223, 0.0, 0.0, 0.15229572355747223, 0.0, 1.3954840898513794, 1.2396692037582397, 1.0562083721160889, 0.0, 0.0, 0.0, 1.2249348163604736, 0.0, 1.5508219003677368, 0.0, 0.0, 0.0, 0.0, 1.7968125343322754, 4.739763259887695, 0.7517045736312866, 2.2259364128112793, 0.0, 0.04754865542054176, 0.31244662404060364, 0.012341924011707306, 2.029108762741089, 0.23859696090221405, 0.09972747415304184, 0.0, 0.442090779542923, 0.03700050711631775, 0.0, 1.0869014263153076, 0.9975389242172241, 0.006190634332597256, 0.20155416429042816, 0.0, 0.0, 0.8668297529220581, 2.29268217086792, 0.6416518092155457, 0.4694872498512268, 0.19825275242328644, 0.0, 3.151336908340454, 0.4875090420246124, 3.677149772644043, 2.8642590045928955, 0.012763912789523602, 0.0, 0.0, 0.0, 5.081966876983643, 0.07955146580934525, 2.045201539993286, 1.6289377212524414, 0.8417032957077026, 0.009143841452896595, 0.0, 0.3140275776386261, 1.1105509996414185, 0.029695453122258186, 1.2708762884140015, 0.27588656544685364, 1.824172854423523, 0.09922140836715698, 0.9922273755073547, 0.5743665099143982, 0.0, 0.6061343550682068, 0.0, 0.0, 0.13089217245578766, 0.9172128438949585, 0.0, 0.052766650915145874, 7.559141159057617, 0.7080390453338623, 0.0, 0.0, 0.0, 0.02870761603116989, 0.0, 0.0, 0.0, 0.0, 0.0, 0.4955309331417084, 0.12063533067703247, 0.0, 0.0, 3.5031769275665283, 0.0, 0.0, 0.0, 1.0909384489059448, 3.157001495361328, 0.10272913426160812, 4.394540786743164, 0.0, 0.0, 0.0, 1.648627758026123, 2.6097729206085205, 1.3229429721832275, 0.0, 0.0, 0.0, 2.659400701522827, 1.8760682344436646, 0.06505544483661652, 0.0, 0.0, 0.19072569906711578, 0.0, 0.21594741940498352, 0.6074590682983398, 0.11999782174825668, 2.404294967651367, 0.2622281014919281, 0.0, 0.15518802404403687, 0.22970639169216156, 0.0, 0.3130853772163391, 0.056316640228033066, 0.0, 0.0, 0.0, 0.0, 7.223553657531738, 0.0, 0.0, 0.0, 0.6236788034439087, 0.014895010739564896, 0.0, 1.125630259513855, 0.42627203464508057, 0.5976119041442871, 0.0, 0.27091333270072937, 0.8405212759971619, 0.0, 0.03115515038371086, 0.7115228772163391, 0.0, 3.8654937744140625, 2.6445319652557373, 0.15609824657440186, 0.0, 4.887462615966797, 0.19501833617687225, 0.3264361619949341, 5.295635223388672, 0.0, 0.021937180310487747, 0.0, 0.0, 0.9314133524894714, 0.4000808596611023, 0.11935077607631683, 0.0972614511847496, 5.657236576080322, 0.0, 0.3165815472602844, 4.48142147064209, 0.09148792177438736, 0.0, 0.6271491050720215, 0.0, 0.0, 0.40620845556259155, 0.12071535736322403, 1.6232799291610718, 0.0, 0.0, 0.0, 0.35675790905952454, 0.0, 2.357745409011841, 0.9542337656021118, 2.903998613357544, 0.0, 0.0, 1.5145161151885986, 5.264035701751709, 0.0, 0.0, 0.0, 3.723191022872925, 0.18974852561950684]'
# s = eval(str1)
# image_id = find_image_id_by_1024('/home/st/ImageNet/csv_ID_1024_label_64.csv', list, s, 5)
# # print image_id
# image_file = find_image(image_id)
# # print image_file
# for i in range(len(image_file)):
#     img = Image.open(image_file[i])
#     img.show()





